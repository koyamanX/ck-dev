<!doctype html><html lang=en><meta charset=utf-8><meta name=generator content="Hugo 0.82.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><title>My RISC-V debug feature part4&nbsp;&ndash;&nbsp;ck-dev</title><link rel=stylesheet href=https://koyamanx.github.io/ck-dev/css/core.min.3ad30501c32a51e6255508e9b30685dba7abb22436bad9f6836882eb9a79698ca0598981990d0789c1808e089fbf7176.css integrity=sha384-OtMFAcMqUeYlVQjpswaF26ersiQ2utn2g2iC65p5aYygWYmBmQ0HicGAjgifv3F2><meta name=twitter:card content="summary"><meta name=twitter:title content="My RISC-V debug feature part4"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=https://koyamanx.github.io/ck-dev/><span class="site name">ck-dev</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class="nav item" href=https://koyamanx.github.io/ck-dev/categories/>Categories</a><a class="nav item" href=https://koyamanx.github.io/ck-dev/tags/>Tags</a><a class="nav item" href=https://koyamanx.github.io/ck-dev/about>About</a></nav></div></span></div><div class="site slogan"><span class=title>Notes for myself</span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">My RISC-V debug feature part4</h1><p class="article date">Sunday, May 9, 2021</p></section><article class="article markdown-body"><p>これから、DM(Debug Module)の実装をおこない、VJTAGを通して、OpenOCDと情報をやりとりできるかを確認していく。
まずは、かんたんな実装から始める。
参照しているspecのバージョンは<code>v0.13</code>である。</p><h2 id=機能>機能</h2><ul><li>対象のHartsの選択</li><li>Halt/Resume</li><li>Abstracts commands</li><li>Program buffer</li><li>ステップ実行</li><li>トリガー</li><li>リセット
などが挙げられる。
なお、Debuggerが介入してきた場合は、hartはD-Mode(Debug Mode)で動作を行う。
D-Modeでは、基本的にはM-Modeと同じだが、割り込みが無効になり、例外はデバッガが対処を行う。また、デバッカーから命令が供給されるまで、haltする。</li></ul><h2 id=全体像>全体像</h2><p><span class=image-container><span class=link><a href=./image00.png target=_blank><img class=img src=./image00.png></a></span></span>
実線で囲まれている部分は実装が必須であり、点線で囲まれている部分は実装するかは任意である。
今回は、実線の部分のみ実装する。
なお、DTMに関してはほとんど前回までで実装が完了している。
また、VJTAGおよびDTM、DMはTCK(VJTAGのクロックドメイン)で動作している。
そこで、hart &lt;-> DM間にクロックドメインクロッシングの機構を用意する。
念の為記しておくが、System busへのアクセスは実装しないが、System busは<code>m_clock</code>ドメインで動作している。
<span class=image-container><span class=link><a href=./image01.png target=_blank><img class=img src=./image01.png></a></span></span></p><h3 id=csrs>CSRs</h3><ul><li>dcsr</li><li>dpc</li><li>dscratch(0..N)</li></ul><p>うち、<code>dpc</code>, <code>dscratch</code>はXLEN bitであり、<code>dcsr</code>は最長<code>2**3</code>ビットである。</p><h2 id=今回実装する機能>今回実装する機能</h2><h3 id=ver1>Ver1</h3><ul><li>hartの選択</li><li>(halt中の)GPRsに対するアクセス</li><li>hartのリセット(resetvectorからの再実行)</li><li>いくつかのAbstarct Commands</li><li>halt/resume</li></ul><h3 id=ver2>ver2</h3><ul><li>ステップ実行</li><li>Triggers</li><li>Program Buffer</li></ul><p>とりあえず、ver1を実装する。
Spikeや他のRTLによる実装を参考に実装していく。
次回からは、hartの選択、halt、GPRsへのアクセスを実装する。
内容が薄いが今回はここまで。</p><h2 id=付録-spikeのビルド>付録 Spikeのビルド</h2><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>git clone --recursive https://github.com/riscv/riscv-isa-sim
<span class=nb>cd</span> riscv-isa-sim
mkdir build
<span class=nb>cd</span> build
../configure --prefix<span class=o>=</span><span class=nv>$RISCV</span> --enable-commitlog --enable-histogram
make -j <span class=k>$(</span>nproc<span class=k>)</span>
make install
</code></pre></div><p>これで、デバックモードの機能を扱うことができる。</p><h2 id=参考>参考</h2><ul><li>ドキュメント・スペック<ul><li><a href=https://sifive.cdn.prismic.io/sifive/fab000f6-0e07-48d0-9602-e437d5367806_sifive_U54MC_rtl_full_20G1.03.00_manual.pdf target=_blank rel="noopener noreferrer">SiFive E31/E51 Coreplex</a></li><li><a href=https://riscv.org/wp-content/uploads/2017/05/Wed1445_Debug_WorkingGroup_Wachs.pdf target=_blank rel="noopener noreferrer">RISC-V Debug Spec Update</a></li><li><a href=https://www.lauterbach.com/pdfnew/debugger_riscv.pdf target=_blank rel="noopener noreferrer">https://www.lauterbach.com/pdfnew/debugger_riscv.pdf</a></li></ul></li><li>実装<ul><li><a href=https://github.com/riscv/riscv-isa-sim target=_blank rel="noopener noreferrer">Spike</a></li><li><a href=https://github.com/aquaxis/riscv_debug target=_blank rel="noopener noreferrer">https://github.com/aquaxis/riscv_debug</a></li></ul></li></ul></article><section class="article labels"><a class=category href=https://koyamanx.github.io/ck-dev/categories/risc-v/>RISC-V</a><a class=tag href=https://koyamanx.github.io/ck-dev/tags/risc-v/>RISC-V</a><a class=tag href=https://koyamanx.github.io/ck-dev/tags/jtag/>JTAG</a><a class=tag href=https://koyamanx.github.io/ck-dev/tags/fpga/>FPGA</a></section><div class="article share addthis_inline_share_toolbox"></div><script defer src="https://koyamanx.github.io/ck-dev/js/addthis_widget.min.99872df1091f055fca553e0b74b13c09bd383ef42b1c56a9edb651a91f122d56e7bc9a2fad73528246215b379b043226.js#pubid=x-1234567890" integrity=sha384-mYct8QkfBV/KVT4LdLE8Cb04PvQrHFap7bZRqR8SLVbnvJovrXNSgkYhWzebBDIm></script></div><div class="article bottom"><section class="article navigation"><p><a class=link href=https://koyamanx.github.io/ck-dev/blog/my_riscv_debug_feature_part3/><span class="iconfont icon-article"></span>My RISC-V debug feature part3</a></p></section></div></section><section id=footer><div class=footer-wrap><p class=copyright>©2021 koyamanX</p><p class=powerby><span>Powered&nbsp;by&nbsp;</span><a href=https://gohugo.io target=_blank rel="noopener noreferrer">Hugo</a><span>&nbsp;&&nbsp;</span><a href=https://themes.gohugo.io/hugo-notepadium/ target=_blank rel="noopener noreferrer">Notepadium</a></p></div></section></body></html>